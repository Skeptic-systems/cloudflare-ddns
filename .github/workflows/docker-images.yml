name: Build and Push Docker Images

on:
  workflow_dispatch:
    inputs:
      target:
        description: Select which image to build
        required: true
        default: both
        type: choice
        options:
          - both
          - full
          - api

env:
  REGISTRY: docker.io
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  prepare-version:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      next_version: ${{ steps.determine.outputs.next_version }}
    steps:
      - name: Verify Docker Hub credentials
        run: |
          if [ -z "${DOCKERHUB_USERNAME}" ] || [ -z "${DOCKERHUB_TOKEN}" ]; then
            echo "::error::Missing Docker Hub credentials. Please set DOCKERHUB_USERNAME and DOCKERHUB_TOKEN secrets."
            exit 1
          fi

      - name: Determine next release version
        id: determine
        env:
          DOCKERHUB_USERNAME: ${{ env.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ env.DOCKERHUB_TOKEN }}
        run: |
          set -euo pipefail
          repos=("cloudflare-ddns" "cloudflare-ddns-api")
          max_major=0
          max_minor=0
          max_patch=0
          found=false

          for repo in "${repos[@]}"; do
            url="https://hub.docker.com/v2/repositories/${DOCKERHUB_USERNAME}/${repo}/tags?page_size=100"
            response_file="$(mktemp)"
            status_code="$(curl -sS -u "${DOCKERHUB_USERNAME}:${DOCKERHUB_TOKEN}" -w "%{http_code}" -o "${response_file}" "${url}")"

            if [ "${status_code}" = "404" ]; then
              echo "Repository ${DOCKERHUB_USERNAME}/${repo} not found; starting fresh."
              rm -f "${response_file}"
              continue
            fi

            if [ "${status_code}" != "200" ]; then
              echo "::error::Failed to query tags for ${repo}. HTTP status ${status_code}."
              cat "${response_file}"
              rm -f "${response_file}"
              exit 1
            fi

            names="$(jq -r '.results[].name' "${response_file}" || true)"
            rm -f "${response_file}"

            while IFS= read -r name; do
              if [[ "${name}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                found=true
                IFS='.' read -r major minor patch <<< "${name}"
                if (( major > max_major )) || \
                   (( major == max_major && minor > max_minor )) || \
                   (( major == max_major && minor == max_minor && patch > max_patch )); then
                  max_major="${major}"
                  max_minor="${minor}"
                  max_patch="${patch}"
                fi
              fi
            done <<< "${names}"
          done

          if [ "${found}" = false ]; then
            next_version="0.1.0"
          else
            next_minor=$((max_minor + 1))
            next_version="${max_major}.${next_minor}.0"
          fi

          echo "next_version=${next_version}" >> "${GITHUB_OUTPUT}"

  build-and-push:
    needs: prepare-version
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: full
            context: .
            dockerfile: dockerfile
            repository: cloudflare-ddns
            build_args: |
              NODE_ENV=production
          - target: api
            context: .
            dockerfile: apps/api/Dockerfile
            repository: cloudflare-ddns-api
            build_args: |
              NODE_ENV=production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Verify Docker Hub credentials
        run: |
          if [ -z "${DOCKERHUB_USERNAME}" ] || [ -z "${DOCKERHUB_TOKEN}" ]; then
            echo "::error::Missing Docker Hub credentials. Please set DOCKERHUB_USERNAME and DOCKERHUB_TOKEN secrets."
            exit 1
          fi

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Build and push image
        if: ${{ github.event.inputs.target == 'both' || github.event.inputs.target == matrix.target }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          build-args: ${{ matrix.build_args }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ matrix.repository }}:${{ needs.prepare-version.outputs.next_version }}
            ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ matrix.repository }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.prepare-version.outputs.next_version }}

